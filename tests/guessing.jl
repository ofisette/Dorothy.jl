using Test
using Dorothy
using Dorothy: guesselement, guessmass
using Formats
using FormatStreams

datapath = joinpath(@__DIR__, "..", "data")

@testset "Property guessing" begin

	@testset "Guessing elements" begin
		m1 = readf("$(datapath)/1BTL.gro")
		@test guesselement("CA", "CA") == "Ca"
		@test guesselement("CL", "CL") == "Cl"
		@test guesselement("CA", "ASP") == "C"
		@test guesselement("N", "ASP") == "N"
		@test_throws Exception guesselement("", "ASP")
		guesselements!(m1)
		@test m1.elements[1:4] == ["N", "C", "C", "O"]
	end

	@testset "Guessing masses" begin
		m1 = readf("$(datapath)/1BTL.gro")
		@test guessmass("MN1", "") == 0.0
		@test guessmass("HG11", "H") == 1.008
		@test_throws Exception guessmass("", "")
		guessmasses!(m1)
		@test m1.masses[1:4] == [14.00, 12.01, 12.01, 15.99]
	end

	@testset "Guessing SS" begin
		m1 = readf("$(datapath)/1BTL.gro")
		guessss!(m1)
		@test m1.SS == ["C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "C", "C", "C", "C", "C", "C", "C", "C",
				"C", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "C", "C", "C", "C", "C", "C", "C", "C", "C", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "C",
				"C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "C", "C", "C", "C", "C", "C", "C", "C", "G", "G", "G",
				"G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G",
				"G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G",
				"G", "G", "G", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C",
				"C", "C", "C", "C", "C", "C", "C", "C", "C", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "C", "C", "C", "C", "C",
				"C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C",
				"C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "G", "G", "G",
				"G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G",
				"G", "G", "G", "G", "G", "G", "G", "G", "G", "C", "C", "C", "C",
				"C", "C", "C", "C", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G",
				"G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C",
				"C", "C", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "C", "C", "C", "C", "C", "C", "C", "C", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "C", "C", "C",
				"C", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "B", "B", "B", "B", "B", "B",
				"B", "B", "B", "B", "B", "C", "C", "C", "C", "C", "C", "C", "C",
				"C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C",
				"C", "C", "C", "C", "C", "C", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "G", "G", "G",
				"G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G",
				"G", "G", "G", "G", "G", "G", "G", "G", "G", "C", "C", "C", "C",
				"C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "C", "C", "C", "C", "C", "C", "C", "C",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "C", "C", "C", "C", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G",
				"G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G", "G",
				"G", "G", "G", "G", "G", "G", "G", "C", "C", "C", "C", "C", "C",
				"C", "C", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T",
				"T", "T", "T", "T", "T", "T", "T", "T", "C", "C", "C", "C", "C",
				"C", "C", "C", "C", "C", "C", "C", "C", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E",
				"E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "C", "C", "C",
				"C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C",
				"C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C",
				"C", "C", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", "H",
				"H", "H", "H", "H", "C", "C", "C", "C", "C", "C", "C", "C", "C",
				"C", "C", "C", "C", "C", "C", "", "", "", "", "", "", "", "",
				"", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
				"", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
				"", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
				"", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
				"", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
				"", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
				"", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
				"", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
				"", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
				"", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
				"", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
				"", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
				"", "", "", ""]
	end

	@testset "Guessing topology" begin
		m1 = readf("$(datapath)/1BTL.gro")
		topo = guesstopology!(m1)
		@test topo[1] == [2]
		@test topo[2] == [1,3,5]
		@test topo[3] == [2,4,11]
		@test topo[4] == [3]
		m2 = readf("$(datapath)/MHC.pdb")
		topo = guesstopology!(m2)
		@test topo[1] == []
		@test topo[3] == [4,5,6,7]
		@test topo[4] == [3]
		@test topo[6540] == [6541, 6542]
	end

end # @testset
